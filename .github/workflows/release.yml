name: Release

on:
  push:
    branches:
      - main


env:
  NODE_VERSION: 22
  DEPLOY_DIR: goblin-bot
  APP_NAME: goblin-bot

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install
        run: npm ci

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: goblin-bot-${{ github.sha }}
          if-no-files-found: error
          path: |
            dist/
            package.json
            package-lock.json

  deploy-discord-commands:
    name: Deploy Discord commands
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install
        run: npm ci

      - name: Deploy
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
        run: |
          if [ -z "${DISCORD_GUILD_ID:-}" ]; then unset DISCORD_GUILD_ID; fi
          npm run deploy

  deploy-server:
    name: Deploy to server
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: goblin-bot-${{ github.sha }}

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
          CLASH_OF_CLANS_API_TOKEN: ${{ secrets.CLASH_OF_CLANS_API_TOKEN }}
          CLASH_OF_CLANS_API_BASE_URL: ${{ vars.CLASH_OF_CLANS_API_BASE_URL }}
          CLASH_OF_CLANS_API_TIMEOUT_MS: ${{ vars.CLASH_OF_CLANS_API_TIMEOUT_MS }}
          BOT_INSTANCE_LABEL: ${{ vars.BOT_INSTANCE_LABEL }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL }}
        run: |
          if [ -z "$SSH_HOST" ]; then
            echo "Missing required secret: SSH_HOST"
            exit 1
          fi

          echo "Deploying to $SSH_HOST:${{ env.DEPLOY_DIR }}"

          ssh -o StrictHostKeyChecking=no -o LogLevel=ERROR "$SSH_HOST" "mkdir -p '${{ env.DEPLOY_DIR }}'"

          rsync -az --delete -e "ssh -o StrictHostKeyChecking=no -o LogLevel=ERROR" dist/ "$SSH_HOST":"${{ env.DEPLOY_DIR }}"/dist/
          rsync -az -e "ssh -o StrictHostKeyChecking=no -o LogLevel=ERROR" package.json package-lock.json "$SSH_HOST":"${{ env.DEPLOY_DIR }}"/

          ssh -o StrictHostKeyChecking=no -o LogLevel=ERROR "$SSH_HOST" bash -s << 'ENDSSH' \
            "${{ env.DEPLOY_DIR }}" \
            "${{ env.APP_NAME }}" \
            "${{ env.NODE_VERSION }}" \
            "$DISCORD_TOKEN" \
            "$DISCORD_CLIENT_ID" \
            "${DISCORD_GUILD_ID:-}" \
            "${CLASH_OF_CLANS_API_TOKEN:-}" \
            "${CLASH_OF_CLANS_API_BASE_URL:-}" \
            "${CLASH_OF_CLANS_API_TIMEOUT_MS:-}" \
            "${BOT_INSTANCE_LABEL:-}" \
            "${LOG_LEVEL:-}"
            set -euo pipefail
            
            DEPLOY_DIR="$1"
            APP_NAME="$2"
            NODE_VERSION="$3"
            DISCORD_TOKEN="$4"
            DISCORD_CLIENT_ID="$5"
            DISCORD_GUILD_ID="$6"
            CLASH_OF_CLANS_API_TOKEN="$7"
            CLASH_OF_CLANS_API_BASE_URL="$8"
            CLASH_OF_CLANS_API_TIMEOUT_MS="$9"
            BOT_INSTANCE_LABEL="${10}"
            LOG_LEVEL="${11}"
            
            # Export all variables so PM2 can pick them up
            export DEPLOY_DIR APP_NAME NODE_VERSION NODE_ENV='production'
            export DISCORD_TOKEN DISCORD_CLIENT_ID
            [ -n "$DISCORD_GUILD_ID" ] && export DISCORD_GUILD_ID
            [ -n "$CLASH_OF_CLANS_API_TOKEN" ] && export CLASH_OF_CLANS_API_TOKEN
            [ -n "$CLASH_OF_CLANS_API_BASE_URL" ] && export CLASH_OF_CLANS_API_BASE_URL
            [ -n "$CLASH_OF_CLANS_API_TIMEOUT_MS" ] && export CLASH_OF_CLANS_API_TIMEOUT_MS
            [ -n "$BOT_INSTANCE_LABEL" ] && export BOT_INSTANCE_LABEL
            [ -n "$LOG_LEVEL" ] && export LOG_LEVEL
            
            # Log environment variables (masking sensitive values)
            echo "=== Environment Variables ==="
            echo "DEPLOY_DIR=$DEPLOY_DIR"
            echo "APP_NAME=$APP_NAME"
            echo "NODE_VERSION=$NODE_VERSION"
            echo "NODE_ENV=production"
            echo "DISCORD_TOKEN=${DISCORD_TOKEN:+SET (${#DISCORD_TOKEN} chars)}"
            echo "DISCORD_CLIENT_ID=$DISCORD_CLIENT_ID"
            echo "DISCORD_GUILD_ID=${DISCORD_GUILD_ID:-<not set>}"
            echo "CLASH_OF_CLANS_API_TOKEN=${CLASH_OF_CLANS_API_TOKEN:+SET (${#CLASH_OF_CLANS_API_TOKEN} chars)}"
            echo "CLASH_OF_CLANS_API_BASE_URL=${CLASH_OF_CLANS_API_BASE_URL:-<not set>}"
            echo "CLASH_OF_CLANS_API_TIMEOUT_MS=${CLASH_OF_CLANS_API_TIMEOUT_MS:-<not set>}"
            echo "BOT_INSTANCE_LABEL=${BOT_INSTANCE_LABEL:-<not set>}"
            echo "LOG_LEVEL=${LOG_LEVEL:-<not set>}"
            echo "============================="
            
            DEPLOY_PATH="$HOME/$DEPLOY_DIR"

            : "${DISCORD_TOKEN:?Missing DISCORD_TOKEN (configure GitHub Secret)}"
            : "${DISCORD_CLIENT_ID:?Missing DISCORD_CLIENT_ID (configure GitHub Secret)}"

            if [ -n "${NVM_DIR:-}" ] && [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            elif [ -s "$HOME/.nvm/nvm.sh" ]; then
              export NVM_DIR="$HOME/.nvm"
              . "$NVM_DIR/nvm.sh"
            fi

            cd "$DEPLOY_PATH"

            if command -v nvm >/dev/null 2>&1; then
              nvm install "${NODE_VERSION:-22}"
              nvm use "${NODE_VERSION:-22}"
            fi

            # Install build dependencies if not already present (needed for native modules)
            if ! command -v make >/dev/null 2>&1; then
              echo "Installing build dependencies..."
              if command -v apt-get >/dev/null 2>&1; then
                DEBIAN_FRONTEND=noninteractive apt-get update -qq
                DEBIAN_FRONTEND=noninteractive apt-get install -y -qq build-essential python3
              elif command -v yum >/dev/null 2>&1; then
                yum install -y -q gcc gcc-c++ make python3
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache build-base python3
              fi
            fi

            npm ci --omit=dev

            if command -v pm2 >/dev/null 2>&1; then
              if pm2 describe "$APP_NAME" > /dev/null 2>&1; then
                pm2 restart "$APP_NAME" --update-env
              else
                pm2 start "$DEPLOY_PATH/dist/index.js" --name "$APP_NAME" --time
              fi
              pm2 save
            else
              echo "pm2 is not installed on server; skipping process restart"
            fi
          ENDSSH
